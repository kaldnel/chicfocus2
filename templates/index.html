<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChicFocus - Real-time Productivity Tracker</title>
    <link id="user-stylesheet" rel="stylesheet" href="">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <!-- Connection indicator -->
    <div class="connection-indicator" title="Connection status"></div>
    
    <div class="app-container">
        <!-- User Selection Modal -->
        <div id="user-modal" class="modal">
            <div class="modal-content">
                <h2>Select User</h2>
                <div class="user-selection">
                    <button onclick="selectUser('luu')" class="user-btn luu-btn">
                        <img src="{{ url_for('static', filename='images/luu-logo.png') }}" alt="luu" class="user-logo">
                    </button>
                    <button onclick="selectUser('4keni')" class="user-btn keni-btn">
                        <img src="{{ url_for('static', filename='images/4keni-logo.png') }}" alt="4keni" class="user-logo">
                    </button>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="hidden">
            <header>
                <div class="panel-header">
                    <!-- Remove logo reference -->
                    <h1>ChicFocus</h1>
                    <div class="user-info">
                        <span id="current-user"></span>
                        <button onclick="logout()" class="logout-btn">Logout</button>
                    </div>
                </div>
            </header>

            <div class="split-container">
                <!-- Left Side - Current User -->
                <div class="user-panel" id="current-user-panel">
                    <h2 id="current-user-name"></h2>
                    
                    <!-- Task Input -->
                    <div class="task-section card">
                        <h3>Start New Chicken</h3>
                        <input type="text" id="task-name" placeholder="Enter task name...">
                        
                        <div class="tier-selection">
                            <h4>Choose Chicken Tier:</h4>
                            {% for tier, info in chicken_types.items() %}
                            <label class="tier-option">
                                <input type="radio" name="tier" value="{{ tier }}" {% if tier == 1 %}checked{% endif %}>
                                Tier {{ tier }} ({{ info.time }}min - {{ info.points }}pts)
                            </label>
                            {% endfor %}
                        </div>
                        
                        <button id="start-btn" onclick="startChicken()">Start Chicken</button>
                    </div>

                    <!-- Timer -->
                    <div class="timer-section card">
                        <div id="timer-display">00:00</div>
                        <div id="timer-status">Ready to start</div>
                        <div class="timer-controls">
                            <button id="pause-btn" onclick="pauseTimer()" disabled>Pause</button>
                            <button id="reset-btn" onclick="resetTimer()" disabled>Reset</button>
                        </div>
                    </div>

                    <!-- Current User Stats -->
                    <div class="stats-section card">
                        <h3>Your Stats</h3>
                        <div id="current-stats">
                            <div>Points: <span id="current-points">0</span></div>
                            <div>Today's Chickens: <span id="current-sessions">0</span>/5</div>
                        </div>
                    </div>
                    
                    <!-- Folder Management -->
                    <div class="folder-management card">
                        <div class="folder-header">
                            <h3>Folders</h3>
                            <button onclick="createNewFolder()" class="sm-btn">+ New Folder</button>
                        </div>
                        
                        <div class="folder-count">
                            Current folder: <span id="current-folder-name">Default</span>
                            <span id="folder-chicken-count">(0 chickens)</span>
                        </div>
                        
                        <div class="folder-tree" id="folder-tree">
                            <!-- Folder tree will be populated by JS -->
                        </div>
                        
                        <div class="folder-content" id="folder-content">
                            <!-- Folder contents will be populated by JS -->
                            <div class="empty-folder-msg">No chickens in this folder yet.</div>
                        </div>
                    </div>
                </div>

                <!-- Right Side - Partner -->
                <div class="user-panel" id="partner-panel">
                    <h2 id="partner-name"></h2>
                    
                    <!-- Partner Timer -->
                    <div class="timer-section card">
                        <div id="partner-timer">00:00</div>
                        <div id="partner-status">Idle</div>
                    </div>

                    <!-- Partner Stats -->
                    <div class="stats-section card">
                        <h3>Partner Stats</h3>
                        <div id="partner-stats">
                            <div>Points: <span id="partner-points">0</span></div>
                            <div>Today's Chickens: <span id="partner-sessions">0</span>/5</div>
                        </div>
                    </div>

                    <!-- Partner Folder View -->
                    <div class="partner-folders card">
                        <h3>Partner's Folders</h3>
                        <div class="partner-folder-tree" id="partner-folder-tree">
                            <!-- Partner folder tree will be populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Section - Cycle Info and Log -->
            <div class="bottom-section">
                <div class="cycle-info">
                    <span>Days remaining: <span id="days-remaining">7</span></span>
                    <button onclick="endCycle()" class="end-cycle-btn">End Cycle</button>
                </div>

                <div class="full-log card">
                    <h3>Complete Log</h3>
                    <div id="full-log"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Folder Creation/Edit Modal -->
    <div id="folder-modal" class="modal hidden">
        <div class="modal-content">
            <h2 id="folder-modal-title">New Folder</h2>
            <input type="text" id="folder-name" placeholder="Folder name">
            
            <div class="emoji-selector">
                <label>Choose an emoji (optional):</label>
                <div class="emoji-grid">
                    <button type="button" class="emoji-btn" onclick="selectEmoji('üìÅ')">üìÅ</button>
                    <button type="button" class="emoji-btn" onclick="selectEmoji('üìö')">üìö</button>
                    <button type="button" class="emoji-btn" onclick="selectEmoji('üìù')">üìù</button>
                    <button type="button" class="emoji-btn" onclick="selectEmoji('üíº')">üíº</button>
                    <button type="button" class="emoji-btn" onclick="selectEmoji('üè†')">üè†</button>
                    <button type="button" class="emoji-btn" onclick="selectEmoji('üè´')">üè´</button>
                    <button type="button" class="emoji-btn" onclick="selectEmoji('üéÆ')">üéÆ</button>
                    <button type="button" class="emoji-btn" onclick="selectEmoji('üéµ')">üéµ</button>
                    <button type="button" class="emoji-btn" onclick="selectEmoji('üèãÔ∏è')">üèãÔ∏è</button>
                    <button type="button" class="emoji-btn" onclick="selectEmoji('üç≥')">üç≥</button>
                    <button type="button" class="emoji-btn" onclick="selectEmoji('üì±')">üì±</button>
                    <button type="button" class="emoji-btn" onclick="selectEmoji('üíª')">üíª</button>
                </div>
                <div class="selected-emoji" id="selected-emoji">üìÅ</div>
            </div>
            
            <div class="parent-folder-selector">
                <label>Parent folder (optional):</label>
                <select id="parent-folder-select">
                    <option value="">None (Root level)</option>
                    <!-- Options will be populated by JS -->
                </select>
            </div>
            
            <div class="folder-modal-buttons">
                <button onclick="closeModal('folder-modal')" class="cancel-btn">Cancel</button>
                <button onclick="saveFolder()" class="save-btn">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize socket with error handling
        const socket = io({
            reconnection: true,
            reconnectionAttempts: 10,
            reconnectionDelay: 1000,
            timeout: 30000,
            transports: ['websocket', 'polling']
        });
        
        let currentUser = null;
        let partnerUser = null;
        let timerRunning = false;
        let timerPaused = false;
        let isBreak = false;
        
        // Folder management variables
        let userFolders = [];
        let partnerFolders = [];
        let currentFolderId = null;
        let editingFolderId = null;
        
        // Debug socket connection
        socket.on('connect', () => {
            console.log('Socket connected successfully! ID:', socket.id);
            document.body.classList.add('socket-connected');
        });
        
        socket.on('disconnect', (reason) => {
            console.error('Socket disconnected:', reason);
            document.body.classList.remove('socket-connected');
            alert('Disconnected from server: ' + reason + '. Please refresh the page.');
        });
        
        socket.on('connect_error', (error) => {
            console.error('Socket connection error:', error);
            document.body.classList.remove('socket-connected');
            alert('Connection error: ' + error.message + '. Please refresh the page.');
        });
        
        socket.on('server_connected', (data) => {
            console.log('Server confirmation received:', data);
        });
        
        socket.on('error', (error) => {
            console.error('Socket error:', error);
            alert(error.message || 'An error occurred');
        });
        
        // User selection
        function selectUser(user) {
            currentUser = user;
            partnerUser = user === 'luu' ? '4keni' : 'luu';
            
            // Load appropriate stylesheet
            const stylesheet = document.getElementById('user-stylesheet');
            stylesheet.href = `/static/style.css`;
            
            // Update UI
            document.getElementById('user-modal').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            document.getElementById('current-user').textContent = user;
            document.getElementById('current-user-name').textContent = user;
            document.getElementById('partner-name').textContent = partnerUser;
            
            // Set panel classes for styling
            document.getElementById('current-user-panel').className = `user-panel ${user}-theme`;
            document.getElementById('partner-panel').className = `user-panel ${partnerUser === '4keni' ? 'keni' : partnerUser}-theme`;
        }

        function logout() {
            document.getElementById('user-modal').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
            currentUser = null;
            partnerUser = null;
        }

        // More detailed debug for start chicken
        function startChicken() {
            if (!socket.connected) {
                console.error('Socket not connected! Cannot start chicken.');
                alert('Not connected to server. Please refresh the page and try again.');
                return;
            }
            
            const taskName = document.getElementById('task-name').value.trim();
            const tierInput = document.querySelector('input[name="tier"]:checked');
            
            if (!tierInput) {
                alert('Please select a chicken tier.');
                return;
            }
            
            const tier = tierInput.value;
            
            console.log('Starting chicken with:', { user: currentUser, task_name: taskName, tier: tier });
            
            if (!taskName) {
                alert('Please enter a task name!');
                return;
            }
            
            if (!currentUser) {
                alert('Error: No user selected. Please try logging in again.');
                return;
            }
            
            // Emit the start_chicken event
            socket.emit('start_chicken', {
                user: currentUser,
                task_name: taskName,
                tier: tier
            });
            
            console.log('Chicken start request sent');
            
            // Add a timeout to detect if we don't get a response
            setTimeout(() => {
                // If the timer hasn't started yet, show an error
                if (!timerRunning) {
                    console.error('No response from server after sending start_chicken');
                    alert('No response from server. Please try again or refresh the page.');
                }
            }, 5000);
        }

        // Folder Management Functions
        function createNewFolder() {
            // Reset the folder modal
            document.getElementById('folder-modal-title').textContent = 'Create New Folder';
            document.getElementById('folder-name').value = '';
            document.getElementById('selected-emoji').textContent = 'üìÅ';
            populateParentFolderSelect();
            editingFolderId = null;
            
            // Show the modal
            document.getElementById('folder-modal').classList.remove('hidden');
        }
        
        function editFolder(folderId) {
            const folder = userFolders.find(f => f.id === folderId);
            if (!folder) return;
            
            // Set modal for editing
            document.getElementById('folder-modal-title').textContent = 'Edit Folder';
            document.getElementById('folder-name').value = folder.name;
            document.getElementById('selected-emoji').textContent = folder.emoji || 'üìÅ';
            populateParentFolderSelect(folderId);
            
            // Set the parent folder
            const parentSelect = document.getElementById('parent-folder-select');
            parentSelect.value = folder.parent_id || '';
            
            editingFolderId = folderId;
            
            // Show the modal
            document.getElementById('folder-modal').classList.remove('hidden');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        function selectEmoji(emoji) {
            document.getElementById('selected-emoji').textContent = emoji;
        }
        
        function populateParentFolderSelect(excludeFolderId = null) {
            const select = document.getElementById('parent-folder-select');
            select.innerHTML = '<option value="">None (Root level)</option>';
            
            // Get all potential parent folders (excluding the one being edited)
            userFolders.forEach(folder => {
                if (folder.id !== excludeFolderId) {
                    // Check if this would create a circular reference
                    if (!wouldCreateCircularReference(folder.id, excludeFolderId)) {
                        const option = document.createElement('option');
                        option.value = folder.id;
                        option.textContent = `${folder.emoji || 'üìÅ'} ${folder.name}`;
                        select.appendChild(option);
                    }
                }
            });
        }
        
        function wouldCreateCircularReference(potentialParentId, childId) {
            if (!childId || !potentialParentId) return false;
            
            // Check if any ancestor of potentialParentId is childId
            let currentId = potentialParentId;
            while (currentId) {
                const folder = userFolders.find(f => f.id === currentId);
                if (!folder) return false;
                
                if (folder.parent_id === childId) return true;
                currentId = folder.parent_id;
            }
            
            return false;
        }
        
        function saveFolder() {
            const folderName = document.getElementById('folder-name').value.trim();
            if (!folderName) {
                alert('Please enter a folder name');
                return;
            }
            
            const emoji = document.getElementById('selected-emoji').textContent;
            const parentId = document.getElementById('parent-folder-select').value || null;
            
            if (editingFolderId) {
                // Editing existing folder
                socket.emit('edit_folder', {
                    user: currentUser,
                    folder_id: editingFolderId,
                    name: folderName,
                    emoji: emoji,
                    parent_id: parentId
                });
            } else {
                // Creating new folder
                socket.emit('create_folder', {
                    user: currentUser,
                    name: folderName,
                    emoji: emoji,
                    parent_id: parentId
                });
            }
            
            closeModal('folder-modal');
        }
        
        function deleteFolder(folderId) {
            if (confirm('Are you sure you want to delete this folder? All chickens will be moved to the Default folder.')) {
                socket.emit('delete_folder', {
                    user: currentUser,
                    folder_id: folderId
                });
            }
        }
        
        function selectFolder(folderId) {
            currentFolderId = folderId;
            renderFolderContent();
        }
        
        function renderFolderTree() {
            const treeElement = document.getElementById('folder-tree');
            treeElement.innerHTML = '';
            
            // Function to render a folder and its children
            function renderFolder(folder, level = 0) {
                const folderElement = document.createElement('div');
                folderElement.className = `folder-item ${currentFolderId === folder.id ? 'selected' : ''}`;
                folderElement.style.paddingLeft = `${level * 20}px`;
                folderElement.setAttribute('data-folder-id', folder.id);
                
                // Count chickens in this folder and all subfolders
                const chickenCount = countChickensInFolder(folder.id);
                
                folderElement.innerHTML = `
                    <div class="folder-item-content">
                        <div class="folder-icon">${folder.emoji || 'üìÅ'}</div>
                        <div class="folder-name">${folder.name}</div>
                        <div class="folder-chicken-count">(${chickenCount})</div>
                        <div class="folder-actions">
                            <button class="folder-btn edit" onclick="event.stopPropagation(); editFolder('${folder.id}')">‚úèÔ∏è</button>
                            ${folder.id.endsWith('_default') ? '' : 
                                `<button class="folder-btn delete" onclick="event.stopPropagation(); deleteFolder('${folder.id}')">üóëÔ∏è</button>`}
                        </div>
                    </div>
                `;
                
                folderElement.onclick = () => selectFolder(folder.id);
                
                // Add droppable capabilities for drag-and-drop
                folderElement.ondragover = (e) => {
                    e.preventDefault();
                    folderElement.classList.add('drag-over');
                };
                
                folderElement.ondragleave = () => {
                    folderElement.classList.remove('drag-over');
                };
                
                folderElement.ondrop = (e) => {
                    e.preventDefault();
                    folderElement.classList.remove('drag-over');
                    
                    const chickenId = e.dataTransfer.getData('chickenId');
                    const sourceFolderId = e.dataTransfer.getData('sourceFolderId');
                    
                    if (chickenId && folder.id !== sourceFolderId) {
                        moveChicken(chickenId, sourceFolderId, folder.id);
                    }
                };
                
                treeElement.appendChild(folderElement);
                
                // Render children recursively
                const children = userFolders.filter(f => f.parent_id === folder.id);
                children.forEach(child => renderFolder(child, level + 1));
            }
            
            // Render root folders (folders with no parent)
            const rootFolders = userFolders.filter(f => !f.parent_id);
            rootFolders.forEach(folder => renderFolder(folder));
        }
        
        function renderPartnerFolderTree() {
            const treeElement = document.getElementById('partner-folder-tree');
            treeElement.innerHTML = '';
            
            // Function to render a folder and its children
            function renderFolder(folder, level = 0) {
                const folderElement = document.createElement('div');
                folderElement.className = 'partner-folder-item';
                folderElement.style.paddingLeft = `${level * 20}px`;
                
                // Count chickens in this folder and all subfolders
                const chickenCount = countPartnerChickensInFolder(folder.id);
                
                folderElement.innerHTML = `
                    <div class="folder-item-content">
                        <div class="folder-icon">${folder.emoji || 'üìÅ'}</div>
                        <div class="folder-name">${folder.name}</div>
                        <div class="folder-chicken-count">(${chickenCount})</div>
                    </div>
                `;
                
                treeElement.appendChild(folderElement);
                
                // Render children recursively
                const children = partnerFolders.filter(f => f.parent_id === folder.id);
                children.forEach(child => renderFolder(child, level + 1));
            }
            
            // Render root folders (folders with no parent)
            const rootFolders = partnerFolders.filter(f => !f.parent_id);
            rootFolders.forEach(folder => renderFolder(folder));
        }
        
        function renderFolderContent() {
            const contentElement = document.getElementById('folder-content');
            const currentFolder = userFolders.find(f => f.id === currentFolderId);
            
            if (!currentFolder) {
                // If no folder is selected or the selected folder doesn't exist,
                // select the default folder if available
                const defaultFolder = userFolders.find(f => f.id === `${currentUser}_default`);
                if (defaultFolder) {
                    currentFolderId = defaultFolder.id;
                    renderFolderContent();
                }
                return;
            }
            
            // Update folder name and count display
            document.getElementById('current-folder-name').textContent = 
                `${currentFolder.emoji || 'üìÅ'} ${currentFolder.name}`;
            document.getElementById('folder-chicken-count').textContent = 
                `(${countChickensInFolder(currentFolderId)} chickens)`;
            
            contentElement.innerHTML = '';
            
            if (!currentFolder.chickens || currentFolder.chickens.length === 0) {
                contentElement.innerHTML = '<div class="empty-folder-msg">No chickens in this folder yet.</div>';
                return;
            }
            
            // Sort chickens by completion time, newest first
            const sortedChickens = [...currentFolder.chickens].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp));
            
            sortedChickens.forEach(chicken => {
                const chickenElement = document.createElement('div');
                chickenElement.className = `chicken-item tier-${chicken.tier}`;
                chickenElement.setAttribute('draggable', 'true');
                chickenElement.setAttribute('data-chicken-id', chicken.id);
                
                const completionDate = new Date(chicken.timestamp);
                const timeString = completionDate.toLocaleString();
                
                // Choose chicken image based on tier - updated to use SVG files
                const chickenImage = `/static/images/chicken_tier${chicken.tier}.svg`;
                
                chickenElement.innerHTML = `
                    <div class="chicken-image">
                        <img src="${chickenImage}" alt="Chicken Tier ${chicken.tier}">
                    </div>
                    <div class="chicken-details">
                        <div class="chicken-name">${chicken.task_name}</div>
                        <div class="chicken-time">${timeString}</div>
                        <div class="chicken-tier">Tier ${chicken.tier}</div>
                    </div>
                `;
                
                // Add drag functionality
                chickenElement.ondragstart = (e) => {
                    e.dataTransfer.setData('chickenId', chicken.id);
                    e.dataTransfer.setData('sourceFolderId', currentFolderId);
                    chickenElement.classList.add('dragging');
                };
                
                chickenElement.ondragend = () => {
                    chickenElement.classList.remove('dragging');
                };
                
                contentElement.appendChild(chickenElement);
            });
        }
        
        function countChickensInFolder(folderId) {
            if (!folderId) return 0;
            
            // Get the folder
            const folder = userFolders.find(f => f.id === folderId);
            if (!folder) return 0;
            
            // Count chickens in this folder
            let count = folder.chickens ? folder.chickens.length : 0;
            
            // Recursively count chickens in all subfolders
            const subfolders = userFolders.filter(f => f.parent_id === folderId);
            subfolders.forEach(subfolder => {
                count += countChickensInFolder(subfolder.id);
            });
            
            return count;
        }
        
        function countPartnerChickensInFolder(folderId) {
            if (!folderId) return 0;
            
            // Get the folder
            const folder = partnerFolders.find(f => f.id === folderId);
            if (!folder) return 0;
            
            // Count chickens in this folder
            let count = folder.chickens ? folder.chickens.length : 0;
            
            // Recursively count chickens in all subfolders
            const subfolders = partnerFolders.filter(f => f.parent_id === folderId);
            subfolders.forEach(subfolder => {
                count += countPartnerChickensInFolder(subfolder.id);
            });
            
            return count;
        }
        
        function moveChicken(chickenId, sourceFolderId, targetFolderId) {
            if (sourceFolderId === targetFolderId) return;
            
            socket.emit('move_chicken', {
                user: currentUser,
                chicken_id: chickenId,
                source_folder_id: sourceFolderId,
                target_folder_id: targetFolderId
            });
        }
        
        // Timer functions
        function pauseTimer() {
            if (!timerPaused) {
                socket.emit('pause_timer', {user: currentUser});
            } else {
                socket.emit('resume_timer', {user: currentUser, is_break: isBreak});
            }
        }

        function resetTimer() {
            socket.emit('reset_timer', {user: currentUser});
        }

        function endCycle() {
            if (confirm('Are you sure you want to end the current cycle?')) {
                socket.emit('end_cycle');
            }
        }

        // Socket event handlers
        socket.on('chicken_started', (data) => {
            if (data.user === currentUser) {
                document.getElementById('timer-status').textContent = `Working on: ${data.task_name} (Tier ${data.tier})`;
                document.getElementById('start-btn').disabled = true;
                document.getElementById('pause-btn').disabled = false;
                document.getElementById('reset-btn').disabled = false;
                document.getElementById('task-name').value = '';
                timerRunning = true;
                isBreak = false;
            } else {
                document.getElementById('partner-status').textContent = `${data.task_name} (Tier ${data.tier})`;
            }
        });

        socket.on('timer_update', (data) => {
            if (data.user === currentUser) {
                document.getElementById('timer-display').textContent = data.time;
            } else {
                document.getElementById('partner-timer').textContent = data.time;
            }
        });

        socket.on('timer_paused', (data) => {
            if (data.user === currentUser) {
                document.getElementById('pause-btn').textContent = 'Resume';
                timerPaused = true;
            }
        });

        socket.on('timer_resumed', (data) => {
            if (data.user === currentUser) {
                document.getElementById('pause-btn').textContent = 'Pause';
                timerPaused = false;
            }
        });

        socket.on('timer_reset', (data) => {
            if (data.user === currentUser) {
                document.getElementById('timer-display').textContent = '00:00';
                document.getElementById('timer-status').textContent = 'Ready to start';
                document.getElementById('start-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('reset-btn').disabled = true;
                document.getElementById('pause-btn').textContent = 'Pause';
                timerRunning = false;
                timerPaused = false;
                isBreak = false;
            } else {
                document.getElementById('partner-timer').textContent = '00:00';
                document.getElementById('partner-status').textContent = 'Idle';
            }
        });

        socket.on('break_started', (data) => {
            if (data.user === currentUser) {
                document.getElementById('timer-status').textContent = 'Break time! üê•';
                isBreak = true;
            } else {
                document.getElementById('partner-status').textContent = 'On break üê•';
            }
        });

        socket.on('session_complete', (data) => {
            if (data.user === currentUser) {
                document.getElementById('timer-display').textContent = '00:00';
                document.getElementById('timer-status').textContent = 'Session completed! üéâ';
                document.getElementById('start-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('reset-btn').disabled = true;
                document.getElementById('pause-btn').textContent = 'Pause';
                timerRunning = false;
                timerPaused = false;
                isBreak = false;
                alert('Great job! Your chicken is done. üê•');
            } else {
                document.getElementById('partner-timer').textContent = '00:00';
                document.getElementById('partner-status').textContent = 'Completed session üéâ';
            }
        });
        
        socket.on('chicken_created', (data) => {
            // Refresh the folder view when a chicken is created
            if (data.user === currentUser || data.user === partnerUser) {
                console.log('Chicken created:', data);
            }
        });
        
        socket.on('folders_updated', (data) => {
            if (data.user === currentUser) {
                userFolders = data.folders;
                renderFolderTree();
                renderFolderContent();
            } else if (data.user === partnerUser) {
                partnerFolders = data.folders;
                renderPartnerFolderTree();
            }
        });

        socket.on('full_update', (data) => {
            if (!currentUser) return;
            
            // Update current user stats
            document.getElementById('current-points').textContent = data.users[currentUser].current_points;
            document.getElementById('current-sessions').textContent = data.users[currentUser].sessions_today;
            
            // Update partner stats
            document.getElementById('partner-points').textContent = data.users[partnerUser].current_points;
            document.getElementById('partner-sessions').textContent = data.users[partnerUser].sessions_today;
            
            // Update cycle info
            document.getElementById('days-remaining').textContent = data.days_remaining;
            
            // Update folders
            if (data.users[currentUser].folders) {
                userFolders = data.users[currentUser].folders;
                
                // If no folder is selected yet, select the default folder
                if (!currentFolderId) {
                    const defaultFolder = userFolders.find(f => f.id === `${currentUser}_default`);
                    if (defaultFolder) {
                        currentFolderId = defaultFolder.id;
                    }
                }
                
                renderFolderTree();
                renderFolderContent();
            }
            
            if (data.users[partnerUser].folders) {
                partnerFolders = data.users[partnerUser].folders;
                renderPartnerFolderTree();
            }
            
            // Update log
            updateFullLog(data);
        });

        socket.on('cycle_complete', (data) => {
            let message;
            if (data.winner === 'Tie') {
                message = `It's a tie! Both users have the same points.\nYou'll need to decide together who chooses the next date!`;
            } else {
                message = `üéâ ${data.winner} wins!\n\n${data.winner} gets to choose who picks the next date activity.`;
            }
            alert(message);
        });

        function updateFullLog(data) {
            const allSessions = [];
            
            for (const [user, userData] of Object.entries(data.users)) {
                for (const session of userData.sessions) {
                    allSessions.push({...session, user});
                }
            }
            
            allSessions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const logHtml = allSessions.slice(0, 20).map(session => {
                const date = new Date(session.timestamp);
                const timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
                return `<div class="log-entry full">
                    <span class="user ${session.user}">${session.user}</span>
                    <span class="task-name">${session.task_name}</span>
                    <span class="tier">Tier ${session.tier}</span>
                    <span class="time">${timeStr}</span>
                </div>`;
            }).join('');
            
            document.getElementById('full-log').innerHTML = logHtml;
        }
    </script>
</body>
</html> 